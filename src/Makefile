.PHONY: all clean install uninstall dist tests gcov_report open calc_build main_build

# üîπ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (macOS –∏–ª–∏ Linux)
OS := $(shell uname -s)

ifeq ($(OS), Darwin)  # macOS
    QT_PATH = /Users/nikitapotapov/Qt5.15.16
    LIB_PATHS = -F$(QT_PATH)/lib -L$(QT_PATH)/lib
    LIBS = -framework QtCore -framework QtWidgets -framework QtGui -framework QtPrintSupport
    MOC = $(QT_PATH)/bin/moc
    UIC = $(QT_PATH)/bin/uic
else  # Linux
    QT_PATH = /usr
    LIB_PATHS = -L$(QT_PATH)/lib
    LIBS = -lQt5Core -lQt5Widgets -lQt5Gui -lQt5PrintSupport
    MOC = $(QT_PATH)/bin/moc
    UIC = $(QT_PATH)/bin/uic
endif

INCLUDE_PATHS = -I$(QT_PATH)/include \
                -I$(QT_PATH)/lib/QtCore.framework/Headers \
                -I$(QT_PATH)/lib/QtWidgets.framework/Headers \
                -I$(QT_PATH)/lib/QtGui.framework/Headers \
                -Iqcustomplot.h \
                -Icalc
CC = clang++
CFLAGS = -Wall -Wextra -Werror -std=c++17
LDFLAGS = $(LIB_PATHS) $(LIBS)
LFLAGS = -lgtest_main -lgtest -lpthread

SRC_FILES = smartcalc_model.cpp \
            smartcalc_controller.cpp \
            smartcalc_view.cpp \
            calc/credit.cpp \
            calc/deposit.cpp \
            calc/main.cpp \
            calc/mainwindow.cpp \
            calc/qcustomplot.cpp
OBJ_FILES = smartcalc_model.o smartcalc_controller.o smartcalc_view.o \
            calc/credit.o calc/deposit.o calc/main.o calc/mainwindow.o \
            calc/qcustomplot.o calc/moc_qcustomplot.o

UI_FILES = calc/credit.ui calc/deposit.ui calc/mainwindow.ui
GENERATED_UI_HEADERS = $(UI_FILES:.ui=.h)

MOC_FILES = calc/moc_credit.cpp calc/moc_deposit.cpp calc/moc_mainwindow.cpp
TARGET = calc/smartcalc

# üîπ –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å
all: calc_build main_build

# üîπ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è `Makefile` –¥–ª—è `calc`, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
calc/Makefile:
	cd calc && qmake calc.pro

# üîπ –°–±–æ—Ä–∫–∞ `calc`
calc_build: calc/Makefile $(GENERATED_UI_HEADERS)
	$(MAKE) -C calc -j$(shell nproc || sysctl -n hw.ncpu)

# üîπ –°–±–æ—Ä–∫–∞ `src`
main_build: $(TARGET)

$(TARGET): $(OBJ_FILES) $(MOC_FILES)
	$(CC) $(CFLAGS) $(INCLUDE_PATHS) -o $(TARGET) $(OBJ_FILES) $(MOC_FILES) $(LDFLAGS)

# üîπ –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
calc/%.o: calc/%.cpp $(GENERATED_UI_HEADERS)
	$(CC) $(CFLAGS) $(INCLUDE_PATHS) -c $< -o $@

# üîπ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è `ui_*.h` —Ñ–∞–π–ª–æ–≤
calc/ui_%.h: calc/%.ui
	$(UIC) $< -o $@

# üîπ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è `moc_*.cpp` —Ñ–∞–π–ª–æ–≤
calc/moc_%.cpp: calc/%.h
	$(MOC) $< -o $@

# üîπ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `/usr/local/bin`)
install: $(TARGET)
	mkdir -p /usr/local/bin
	cp $(TARGET) /usr/local/bin/

# üîπ –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
uninstall:
	rm -rf /usr/local/bin/smartcalc ./calc/calc.app

# üîπ –ê—Ä—Ö–∏–≤–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
dist:
	mkdir -p Archive_calc_v2.0/src
	cp $(TARGET) Archive_calc_v2.0/src/
	tar cvzf Archive_calc_v2.0.tgz Archive_calc_v2.0
	rm -rf Archive_calc_v2.0

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
TEST_SRC = test.cpp smartcalc_model.cpp
TEST_OBJ = $(TEST_SRC:.cpp=.o)
TEST_TARGET = test_runner

$(TEST_OBJ): %.o: %.cpp
	$(CC) $(CFLAGS) -c $< -o $@

$(TEST_TARGET): $(TEST_OBJ)
	$(CC) $(CFLAGS) -o $@ $^ $(LFLAGS)

tests: uninstall $(TEST_TARGET)
	./$(TEST_TARGET)

# –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤
clean_tests:
	rm -f $(TEST_OBJ) $(TEST_TARGET)

# üîπ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–¥–∞
gcov_report: $(SRC_FILES)
	$(CC) $(CFLAGS) $(INCLUDE_PATHS) --coverage $(SRC_FILES) -o $(TARGET) $(LDFLAGS)
	./$(TARGET)
	lcov -t "gcov_test" -o gcov_test.info --no-external -c -d .
	genhtml gcov_test.info -o report

# üîπ –û—Ç–∫—Ä—ã—Ç–∏–µ –æ—Ç—á–µ—Ç–∞
open: gcov_report
	open report/index.html

# üîπ –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞
rebuild: clean all

# üîπ –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
clean:
	rm -rf *.o $(TARGET) *.gcno *.gcda gcov_test.info report Archive_calc_v2.0* build \
	    calc/ui_*.h calc/moc_*.cpp calc/moc_*.h calc/*.o calc/Makefile calc/calc.app calc/.qmake.stash
